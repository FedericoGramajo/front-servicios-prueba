@attribute [Route(RouteConstants.AdminDashboard)]
@attribute [Authorize(Roles = Constant.Administration.AdminRole)]
@using ClientLibrary.Helper
@using ClientLibrary.Models.Landing
@using ClientLibrary.Models.Authentication.Rol.Professional
@using ClientLibrary.Services.Contracts
@inject IJSRuntime js
@inject IAdminDashboardService dashboardService
@inject ICategoryService categoryService
@inject IServOfferingService servOfferingService

<PageTitle>Panel administrador - ServicioAhora!</PageTitle>

<div class="landing-page">
    <main class="container py-5 account-layout">
        <div class="section-heading flex-column flex-lg-row">
            <div>
                <p class="text-uppercase text-muted small mb-1">Administración</p>
                <h2 class="mb-0">Control general de rubros, servicios y profesionales</h2>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary">Descargar reportes</button>
                @* <button class="btn btn-primary">Crear registro</button> *@
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "resume" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "resume"'>
                    <i class="fa-solid fa-chart-line me-2"></i>Resumen
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "categories" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "categories"'>
                    <i class="fa-solid fa-layer-group me-2"></i>Rubros
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "services" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "services"'>
                    <i class="fa-solid fa-briefcase me-2"></i>Servicios
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "professionals" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "professionals"'>
                    <i class="fa-solid fa-user-tie me-2"></i>Profesionales
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "audit" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "audit"'>
                    <i class="fa-solid fa-shield-halved me-2"></i>Auditoría
                </button>
            </li>
        </ul>

        <!-- Content -->
        @if (ActiveTab == "resume")
        {
            <AdminSummaryCards Metrics="SummaryMetrics" />
            <AdminReportsSection Categories="Categories"
                                 CategoryReportData="CategoryReportData"
                                 StatusReportData="StatusReportData"
                                 CategoryMax="CategoryMax"
                                 StatusMax="StatusMax" />
        }
        else if (ActiveTab == "categories")
        {
            <AdminCategoryManager Categories="Categories" OnCategoryChanged="LoadCategories" />
        }
        else if (ActiveTab == "services")
        {
             <ServiceTableSection Categories="Categories"
                                  Services="Services"
                                  LocalCulture="LocalCulture"
                                  OnServiceChanged="LoadServices" />
        }
        else if (ActiveTab == "professionals")
        {
            <ProfessionalTableSection Professionals="Professionals" />
        }
        else if (ActiveTab == "audit")
        {
            <AuditLogSection />
        }

    </main>
</div>

@code {
    private readonly CultureInfo LocalCulture = new("es-AR");

    // Tab State
    private string ActiveTab { get; set; } = "resume";

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Tab { get; set; }

    private List<GetCategory> Categories { get; set; } = new();
    private List<GetServiceOffering> Services { get; set; } = new();
    private List<GetProfessional> Professionals { get; set; } = new();
    private List<AdminMetric> SummaryMetrics { get; set; } = new();
    private List<ReportBar> CategoryReportData { get; set; } = new();
    private List<ReportBar> StatusReportData { get; set; } = new();

    private int CategoryMax => CategoryReportData.Any() ? CategoryReportData.Max(r => r.Count) : 0;
    private int StatusMax => StatusReportData.Any() ? StatusReportData.Max(r => r.Count) : 0;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Tab))
        {
            ActiveTab = Tab.ToLower() switch
            {
                "categories" => "categories",
                "services" => "services",
                "professionals" => "professionals",
                _ => "resume"
            };
        }
        await LoadAllData();
    }

    private async Task LoadAllData()
    {
        // Parallel loading for efficiency
        var tasks = new List<Task>
        {
            LoadCategories(),
            LoadServices(),
            LoadMetrics(),
            LoadReports(),
            LoadProfessionals()
        };

        await Task.WhenAll(tasks);
    }

    private async Task LoadCategories()
    {
        var categories = await categoryService.GetAllAsync();
        Categories = categories?.ToList() ?? new List<GetCategory>();
    }
    private async Task LoadServices()
    {
        var servOffering = await servOfferingService.GetAllAsync();
        Services = servOffering?.ToList() ?? new List<GetServiceOffering>();
    }

    private async Task LoadMetrics()
    {
        SummaryMetrics = await dashboardService.GetMetricsAsync();
    }

    private async Task LoadReports()
    {
        var catTask = dashboardService.GetCategoryReportAsync();
        var statusTask = dashboardService.GetStatusReportAsync();
        
        await Task.WhenAll(catTask, statusTask);

        CategoryReportData = await catTask;
        StatusReportData = await statusTask;
    }

    private async Task LoadProfessionals()
    {
        var professionals = await dashboardService.GetProfessionalsAsync();
        Professionals = professionals?.ToList() ?? new List<GetProfessional>();
    }

}
