@page "/forgot-password"

<div class="container-fluid m-5 p-5">
    <div class="row">
        <div class="col-lg-4 offset-4">
            <EditForm Model=@Login OnValidSubmit="SendResetLink">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(Message))
                {
                    <div class="alert alert-@AlertType">@Message</div>
                }

                <div class="card p-4 shadow">
                    <div class="card-header text-center fw-semibold">Recuperar Contraseña</div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <FloatingText @bind-Value="Login.Email"
                                          class="form-control"
                                          Label="Correo electrónico"
                                          Placeholder="tu@email.com"
                                          Type="email"
                                          Required />
                            <ValidationMessage For="() => Login.Email" />
                        </div>
                    </div>

                    <button class="btn btn-primary w-100" type="submit" disabled="@IsLoading">
                        @(IsLoading ? "Enviando enlace..." : "Enviar enlace de recuperación")
                    </button>

                    <div class="mt-3 d-grid gap-2">
                        <a class="btn btn-outline-primary" href="/authentication/login">Volver a iniciar sesión</a>
                        <a class="btn btn-link" href="/">Volver al inicio</a>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    public RequestPasswordReset Login { get; set; } = new();

    // Estado UI
    private string Message = string.Empty;
    private string AlertType = string.Empty;
    private bool IsLoading = false;

    private async Task SendResetLink()
    {
        Message = string.Empty;
        AlertType = string.Empty;
        IsLoading = true;

        try
        {
            var result = await authenticationService.RequestPasswordReset(Login);
            if (!result.Success)
            {
                Message = result.Message ?? "No se pudo enviar el enlace de recuperación.";
                AlertType = "danger";
                return;
            }

            Message = "Te enviamos un enlace de recuperación a tu correo.";
            AlertType = "success";
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Message = "Ocurrió un error inesperado al enviar el correo.";
            AlertType = "danger";
        }
        finally
        {
            IsLoading = false;
        }
    }
}
