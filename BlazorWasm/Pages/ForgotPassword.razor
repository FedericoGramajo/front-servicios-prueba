@page "/forgot-password"

<div class="auth-page py-5 py-lg-6">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-xl-5">

                <EditForm Model="@Login" OnValidSubmit="SendResetLink">
                    <DataAnnotationsValidator />

                    @if (!string.IsNullOrEmpty(Message))
                    {
                        <div class="alert alert-@AlertType text-center fw-semibold">@Message</div>
                    }

                    <div class="card auth-card shadow-lg border-0">
                        <div class="card-body p-4 p-lg-5">
                            <div class="text-center mb-4">
                                <a class="auth-brand d-inline-flex align-items-center" href="/">
                                    <i class="fa-solid fa-house-chimney me-2"></i>
                                    <span class="fw-bold fs-5">ServicioAhora!</span>
                                </a>
                                <p class="text-muted mb-0">Ingresá tu correo para recibir el enlace de recuperación.</p>
                            </div>

                            <div class="form-group mb-4">
                                <label class="form-label fw-semibold" for="forgotEmail">Correo electrónico</label>
                                <FloatingText @bind-Value="Login.Email"
                                              class="form-control"
                                              Label="Correo electrónico"
                                              Placeholder="tu@email.com"
                                              Type="email"
                                              Required />
                                <ValidationMessage For="() => Login.Email" />
                            </div>

                            <div class="d-grid">
                                <button class="btn btn-primary btn-lg" type="submit" disabled="@IsLoading">
                                    @(IsLoading ? "Enviando enlace..." : "Enviar enlace de recuperación")
                                </button>
                            </div>

                            <div class="mt-4 d-grid gap-2">
                                <a class="btn btn-outline-primary" href="/login">Volver a iniciar sesión</a>
                                <a class="btn btn-link text-decoration-none" href="/">Volver al inicio</a>
                            </div>
                        </div>
                    </div>
                </EditForm>

            </div>
        </div>
    </div>
</div>


@code {
    public RequestPasswordReset Login { get; set; } = new();

    private string Message = string.Empty;
    private string AlertType = string.Empty;
    private bool IsLoading = false;

    private async Task SendResetLink()
    {
        Message = string.Empty;
        AlertType = string.Empty;
        IsLoading = true;

        try
        {
            var result = await authenticationService.RequestPasswordReset(Login);
            if (!result.Success)
            {
                Message = result.Message ?? "No se pudo enviar el enlace de recuperación.";
                AlertType = "danger";
                return;
            }

            Message = "Te enviamos un enlace de recuperación a tu correo.";
            AlertType = "success";
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Message = "Ocurrió un error inesperado al enviar el correo.";
            AlertType = "danger";
        }
        finally
        {
            IsLoading = false;
        }
    }
}
