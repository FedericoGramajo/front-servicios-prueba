@attribute [Route(RouteConstants.ClientDashboard)]
@attribute [Authorize(Roles = Constant.Administration.CustomerRole)]
@using ClientLibrary.Models.Landing
@using BlazorWasm.Shared.Client
@using ClientLibrary.Services
@inject IUserProfileService UserProfileService
@inject IServiceHistoryService ServiceHistoryService

<PageTitle>Mi Actividad - ServicioAhora!</PageTitle>

<div class="landing-page">
    <main class="container py-5 account-layout">
        <!-- Header -->
        <div class="section-heading flex-column flex-lg-row mb-4">
            <div>
                <p class="text-uppercase text-muted small mb-1">Mi Actividad</p>
                <h2 class="mb-0">Hola, @(string.IsNullOrEmpty(UserProfile.FullName) ? "Usuario" : UserProfile.FullName.Split(' ')[0])!</h2>
            </div>
            <div class="d-flex gap-2">
                <a class="btn btn-primary" href="@RouteConstants.Search">Buscar servicios</a>
            </div>
        </div>

        <!-- Metrics -->
        <ClientMetrics TotalInvested="@TotalInvested"
                       UpcomingCount="@UpcomingCount" 
                       InProgressCount="@InProgressCount" 
                       CompletedCount="@CompletedCount" />

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "history" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "history"'>
                    <i class="fa-solid fa-chart-line me-2"></i>Mi Actividad
                </button>
            </li>
        </ul>

        <!-- Content -->
        @if (ActiveTab == "history")
        {
            <ClientServiceHistory History="History" />
        }


    </main>
</div>

@code {
    private string ActiveTab { get; set; } = "history";

    // Data State
    private UserProfileModel UserProfile { get; set; } = new();
    private List<ServiceHistoryItem> History { get; set; } = new();

    // Metrics Calculation
    private decimal TotalInvested => History.Where(h => h.Status.Equals("completado", StringComparison.OrdinalIgnoreCase)).Sum(h => h.Total);
    private int UpcomingCount => History.Count(h => h.Date >= DateTime.Today && !h.Status.Equals("completado", StringComparison.OrdinalIgnoreCase));
    private int InProgressCount => History.Count(h => h.Status.Equals("en-progreso", StringComparison.OrdinalIgnoreCase));
    private int CompletedCount => History.Count(h => h.Status.Equals("completado", StringComparison.OrdinalIgnoreCase));


    [Parameter]
    [SupplyParameterFromQuery]
    public string? Tab { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Tab))
        {
            ActiveTab = Tab.ToLower() == "profile" ? "profile" : "history";
        }
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try 
        {
            UserProfile = await UserProfileService.GetProfileAsync() ?? new();
            History = await ServiceHistoryService.GetHistoryAsync() ?? new();
        } 
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
        }
    }
}
