@attribute [Route(RouteConstants.ClientDashboard)]
@attribute [Authorize]
@using ClientLibrary.Models.Landing
@using BlazorWasm.Shared.Client
@using ClientLibrary.Services
@inject IUserProfileService UserProfileService
@inject IServiceHistoryService ServiceHistoryService

<PageTitle>Mi Panel - ServicioAhora!</PageTitle>

<div class="landing-page">
    <main class="container py-5 account-layout">
        <!-- Header -->
        <div class="section-heading flex-column flex-lg-row mb-4">
            <div>
                <p class="text-uppercase text-muted small mb-1">Panel de Cliente</p>
                <h2 class="mb-0">Hola, @(string.IsNullOrEmpty(UserProfile.FullName) ? "Usuario" : UserProfile.FullName.Split(' ')[0])!</h2>
            </div>
            <div class="d-flex gap-2">
                <a class="btn btn-primary" href="@RouteConstants.Search">Buscar servicios</a>
            </div>
        </div>

        <!-- Metrics -->
        <ClientMetrics UpcomingCount="@UpcomingCount" 
                       InProgressCount="@InProgressCount" 
                       CompletedCount="@CompletedCount" />

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "history" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "history"'>
                    <i class="fa-solid fa-clock-rotate-left me-2"></i>Historial de Servicios
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "profile" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "profile"'>
                    <i class="fa-solid fa-user-gear me-2"></i>Mi Perfil
                </button>
            </li>
        </ul>

        <!-- Content -->
        @if (ActiveTab == "history")
        {
            <ClientServiceHistory History="History" />
        }
        else if (ActiveTab == "profile")
        {
            <ClientProfile UserProfile="UserProfile" />
        }

    </main>
</div>

@code {
    private string ActiveTab { get; set; } = "history";

    // Data State
    private UserProfileModel UserProfile { get; set; } = new();
    private List<ServiceHistoryItem> History { get; set; } = new();

    // Metrics Calculation
    private int UpcomingCount => History.Count(h => h.Date >= DateTime.Today && h.Status != "completado");
    private int InProgressCount => History.Count(h => h.Status == "en-progreso");
    private int CompletedCount => History.Count(h => h.Status == "completado");


    [Parameter]
    [SupplyParameterFromQuery]
    public string? Tab { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Tab))
        {
            ActiveTab = Tab.ToLower() == "profile" ? "profile" : "history";
        }
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try 
        {
            // Initializing tasks to run in parallel where possible, but here simple sequence is fine
            UserProfile = await UserProfileService.GetProfileAsync() ?? new();
            History = await ServiceHistoryService.GetHistoryAsync() ?? new();
        } 
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
            // Optional: Show toast error
        }
    }
}
