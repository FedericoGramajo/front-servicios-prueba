@attribute [Route(RouteConstants.Home)]
<PageTitle>Inicio - ServicioAhora!</PageTitle>
@implements IDisposable

<div class="landing-page">

    <HeroSection BadgeText="Bienvenido a ServicioAhora!"
                 Title="Soluciones hogareñas a medida para tu día a día"
                 Description="Coordinamos especialistas confiables para limpieza, reparaciones y mantenimiento con garantías claras, pagos protegidos y seguimiento en línea."
                 Ctas="@HeroCtas"
                 Metrics="@HeroMetrics"
                 OnCtaClick="HandleCtaClick" />

    <section class="container py-5" id="rubros">
        <div class="text-center mb-5">
            <span class="badge rounded-pill bg-primary-subtle text-primary mb-2">Categorías</span>
            <h2 class="fw-bold mb-3">Encontrá lo que necesitás</h2>
            <p class="text-muted lead mx-auto" style="max-width: 600px;">Explorá nuestros rubros más populares y conectá con especialistas calificados.</p>
        </div>

        <div class="row g-4 justify-content-center">
            @if (CategoriesLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            }
            else
            {
                @foreach (var rubro in FeaturedCategories)
                {
                    <div class="col-6 col-md-4 col-lg-2">
                        <a href="@RouteConstants.Search?categoryId=@rubro.Id" class="text-decoration-none">
                            <div class="card h-100 border-0 shadow-sm hover-elevate text-center py-4">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <i class="@(string.IsNullOrEmpty(rubro.Icon) ? "fa-solid fa-layer-group" : rubro.Icon) fa-2x text-primary"></i>
                                    </div>
                                    <h6 class="card-title text-dark mb-0">@rubro.Name</h6>
                                    @* <small class="text-muted">@rubro.Count profesionales</small> *@
                                </div>
                            </div>
                        </a>
                    </div>
                }
            }
        </div>
    </section>

    <ServicesCarousel SectionId="services"
                      CarouselId="servicesCarousel"
                      Subtitle="Servicios destacados"
                      Title="Aliados de confianza para tu hogar"
                      CtaText="Ver catálogo completo"
                      Services="@Services"
                      Culture="@LocalCulture" />

    <ProfessionalsSection SectionId="professionals"
                          CarouselId="professionalsCarousel"
                          TrustGridId="garantias"
                          Subtitle="Profesionales verificados"
                          Title="Conocé a quienes cuidan tu hogar"
                          CtaText="Sumate como profesional"
                          CtaUrl="@($"{RouteConstants.Register}?role=Professional")"
                          Professionals="@Professionals"
                          TrustStats="@TrustStats" />


</div>

@code {
    [Inject] private CategoryStore CategoryStore { get; set; } = default!;
    [Inject] private IServOfferingService ServiceOfferingService { get; set; } = default!;
    [Inject] private IProfessionalService ProfessionalService { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private static readonly CultureInfo LocalCulture = new("es-AR");

    private IEnumerable<GetCategory> FeaturedCategories { get; set; } = Enumerable.Empty<GetCategory>();
    private List<ServiceModel> Services { get; set; } = new();
    private List<ProfessionalModel> Professionals { get; set; } = new();
    private bool CategoriesLoading { get; set; } = true;

    private readonly IReadOnlyList<HeroCtaModel> HeroCtas = new List<HeroCtaModel>
    {
        new("Explorar servicios", "btn btn-primary rounded-pill px-4 py-3 shadow"),
        new("Convertirme en profesional", "btn btn-outline-light rounded-pill px-4 py-3")
    };

    private void HandleCtaClick(string text)
    {
        if (text == "Explorar servicios") Navigation.NavigateTo(RouteConstants.Search);
        else if (text == "Convertirme en profesional") Navigation.NavigateTo($"{RouteConstants.Register}?role=Professional");
    }

    private readonly IReadOnlyList<HeroMetricModel> HeroMetrics = new List<HeroMetricModel>
    {
        new("+2.400", "Intervenciones hogareñas"),
        new("4.9/5", "Satisfacción promedio"),
        new("36 hs", "Tiempo de respuesta"),
        new("24/7", "Soporte al cliente")
    };

    private readonly IReadOnlyList<TrustStatModel> TrustStats = new List<TrustStatModel>
    {
        new("+500", "Profesionales verificados"),
        new("12 ciudades", "Cobertura nacional"),
        new("72h", "Garantía de satisfacción"),
        new("Pagos seguros", "Protección al comprador")
    };

    protected override async Task OnInitializedAsync()
    {
        CategoryStore.OnChange += StateHasChanged;
        
        try
        {
            CategoriesLoading = true;
            await CategoryStore.LoadCategoriesAsync();
            FeaturedCategories = CategoryStore.Categories?.Where(c => c.IsFeatured).Take(6).ToList() ?? new List<GetCategory>();

            // Load Real Professionals
            var realProfessionals = await ProfessionalService.GetActiveProfessionalsAsync();
            var activeProfessionalIds = realProfessionals?.Select(p => p.AppUserId).ToHashSet() ?? new HashSet<string>();

            if (realProfessionals != null)
            {
                Professionals = realProfessionals.Take(6).Select(p => new ProfessionalModel(
                    p.AppUserId, // Used as Slug for simplicity
                    p.FullName,
                    p.Categories.FirstOrDefault() ?? "Especialista",
                    "Ciudad", // Default city if not in model
                    p.ProfileImage,
                    p.AvgRating,
                    p.BookingsCount
                )).ToList();
            }

            // Load Real Services
            var realServices = await ServiceOfferingService.GetAllAsync();
            if (realServices != null)
            {
                var catIcons = CategoryStore.Categories?.ToDictionary(c => c.Id, c => c.Icon) ?? new Dictionary<Guid, string?>();
                
                // Filter by Service Status AND Professional IsActive (via activeProfessionalIds)
                Services = realServices
                    .Where(s => s.Status && activeProfessionalIds.Contains(s.ProfessionalId))
                    .Take(6)
                    .Select(s => new ServiceModel(
                        s.Id.ToString(), 
                        s.Name, 
                        s.Description ?? "", 
                        s.CategoryName, 
                        s.Image, 
                        s.BasePrice,
                        catIcons.TryGetValue(s.CategoryId, out var icon) ? icon : null
                    )).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading landing data: {ex.Message}");
            FeaturedCategories = new List<GetCategory>();
        }
        finally
        {
            CategoriesLoading = false;
        }
    }

    public void Dispose()
    {
        CategoryStore.OnChange -= StateHasChanged;
    }
}
