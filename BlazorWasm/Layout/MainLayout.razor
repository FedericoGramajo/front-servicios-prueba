@inherits LayoutComponentBase
@using ClientLibrary.Helper
@using ClientLibrary.Models.Landing
@using BlazorWasm.Shared.Landing
@using System.Globalization
@using ClientLibrary.Services.Implementations
@inject IAuthenticationService AuthenticationService

<div class="landing-page">
    <LandingHeader HeaderId="main-layout"
                   Brand="ServicioAhora!"
                   BrandHref="@RouteConstants.Home"
                   Search="@SearchBar"
                   AccountLinks="@AccountLinks"
                   NavLinks="@PrimaryNavLinks"
                   UserName="@UserName"
                   UserInitial="@UserInitial" />

    <main>
        <CustomErrorBoundary>
            @Body
        </CustomErrorBoundary>
    </main>

    <LandingFooter FooterId="main-footer"
                   Brand="ServicioAhora!"
                   Description="Coordinamos servicios hogareños confiables con soporte humano y seguimiento en tiempo real."
                   ContactLines="@FooterContact"
                   LinkGroups="@FooterGroups"
                   CurrentYear="@CurrentYear" />
</div>

@code {
    [Inject]
    private AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    private readonly SearchConfig SearchBar = MenuConstants.SearchBarConfig;

    private List<MenuActionModel> AccountLinks { get; set; } = new();
    private readonly IReadOnlyList<NavLinkModel> PrimaryNavLinks = MenuConstants.PrimaryNavLinks;

    private string UserName { get; set; } = string.Empty;
    private string UserInitial { get; set; } = string.Empty;

    private readonly IReadOnlyList<string> FooterContact = MenuConstants.FooterContact;
    private readonly IReadOnlyList<FooterGroupModel> FooterGroups = MenuConstants.FooterGroups;

    private int CurrentYear => DateTime.Now.Year;
    private UserDto? UserProfile { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await UpdateMenu();
        AuthStateProvider.AuthenticationStateChanged += async _ => await UpdateMenu();
    }
    private async Task<UserDto> LoadProfile()
    {
        var profile = await AuthenticationService.GetMyProfile();
        if (profile != null)
        {
            return profile;
        }
        else return null!;
    }
    private async Task UpdateMenu()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var links = new List<MenuActionModel>();

        if (user.Identity?.IsAuthenticated == true)
        {
            UserProfile = await LoadProfile();
            var fullName = UserProfile.FullName;
            if (string.IsNullOrEmpty(fullName))
            {
                fullName = "Usuario";
            }
            
            UserName = fullName.Split(' ')[0]; // First name
            UserInitial = !string.IsNullOrEmpty(UserName) ? UserName[0].ToString().ToUpper() : "U";

            if (user.IsInRole(Constant.Administration.CustomerRole))
            {
                links.Add(new("Mi Actividad", RouteConstants.ClientDashboard));
            }

            links.Add(new("Mi perfil", RouteConstants.Profile));

            if (user.IsInRole(Constant.Administration.AdminRole))
            {
                links.Add(new("Panel administrador", RouteConstants.AdminDashboard));
            }

            if (user.IsInRole(Constant.Administration.ProfessionalRole))
            {
                links.Add(new("Panel profesional", RouteConstants.ProfessionalDashboard));
            }

            links.Add(new("Cerrar sesión", RouteConstants.Logout));
        }
        else
        {
            UserName = string.Empty;
            UserInitial = string.Empty;

            links.Add(new("Iniciar sesión", RouteConstants.Login));
            links.Add(new("Registrarse", RouteConstants.Register));
        }

        AccountLinks = links;
        StateHasChanged();
    }
}
