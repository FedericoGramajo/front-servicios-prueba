@inherits LayoutComponentBase
@using ClientLibrary.Helper
@using ClientLibrary.Models.Landing
@using BlazorWasm.Shared.Landing
@using System.Globalization

<div class="landing-page">
    <LandingHeader HeaderId="main-layout"
                   Brand="ServicioAhora!"
                   BrandHref="@RouteConstants.Home"
                   Search="@SearchBar"
                   AccountLinks="@AccountLinks"
                   NavLinks="@PrimaryNavLinks" />

    <main>
        <CustomErrorBoundary>
            @Body
        </CustomErrorBoundary>
    </main>

    <LandingFooter FooterId="main-footer"
                   Brand="ServicioAhora!"
                   Description="Coordinamos servicios hogareños confiables con soporte humano y seguimiento en tiempo real."
                   ContactLines="@FooterContact"
                   LinkGroups="@FooterGroups"
                   CurrentYear="@CurrentYear" />
</div>

@code {
    [Inject]
    private AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    private readonly SearchConfig SearchBar = new("Buscar servicios hogareños en ServicioAhora!", "Buscar");

    private List<MenuActionModel> AccountLinks { get; set; } = new();
    private readonly IReadOnlyList<NavLinkModel> PrimaryNavLinks = MenuConstants.PrimaryNavLinks;

    private readonly IReadOnlyList<string> FooterContact = new List<string>
    {
        "Tel: +54 11 5555 1111",
        "Email: hola@servicioahora.com",
        "Horario: Lunes a domingo 8 a 22 h"
    };

    private readonly IReadOnlyList<FooterGroupModel> FooterGroups = new List<FooterGroupModel>
    {
        new("Explorá más", new []
        {
            new FooterLinkModel("Servicios", RouteConstants.HashServices),
            new FooterLinkModel("Profesionales", RouteConstants.Professionals),
            new FooterLinkModel("Garantías", RouteConstants.HashGarantias)
        })
    };

    private int CurrentYear => DateTime.Now.Year;

    protected override async Task OnInitializedAsync()
    {
        await UpdateMenu();
        AuthStateProvider.AuthenticationStateChanged += async _ => await UpdateMenu();
    }

    private async Task UpdateMenu()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var links = new List<MenuActionModel>();

        if (user.Identity?.IsAuthenticated == true)
        {
            // Common for all logged in users
            links.Add(new("Mi perfil", RouteConstants.ClientDashboard)); // Or query string logic if needed

            if (user.IsInRole(Constant.Administration.AdminRole))
            {
                links.Add(new("Panel administrador", RouteConstants.AdminDashboard));
            }

            if (user.IsInRole(Constant.Administration.ProfessionalRole))
            {
                links.Add(new("Panel profesional", RouteConstants.ProfessionalDashboard));
            }

            links.Add(new("Cerrar sesión", RouteConstants.Logout));
        }
        else
        {
            // Not logged in
            links.Add(new("Iniciar sesión", RouteConstants.Login));
            links.Add(new("Registrarse", RouteConstants.Register));
        }

        AccountLinks = links;
        StateHasChanged();
    }
}
