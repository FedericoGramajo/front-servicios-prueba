@using System
@using BlazorWasm.Shared.Landing
@using ClientLibrary.Models.Landing

<header class="landing-header" id="@HeaderId">
    <div class="container">
        <div class="topbar d-flex flex-column flex-lg-row align-items-center gap-3 gap-lg-4">
            <a class="brand" href="@BrandHref">@Brand</a>
            <form class="search-bar flex-grow-1" role="search" @onsubmit="OnSearch" @onsubmit:preventDefault>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
                    <input class="form-control" type="search" placeholder="@Search.Placeholder" aria-label="Buscar" @bind="searchTerm" />
                    <button class="btn btn-primary" type="submit">@Search.ButtonText</button>
                </div>
            </form>
            @* <DarkModeToggle /> *@
            <AuthorizeView>
                <Authorized>
                    <div class="dropdown me-2">
                        <button class="btn btn-link position-relative text-dark text-decoration-none dropdown-toggle-no-caret" type="button" id="notifMenu" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-regular fa-bell fa-lg"></i>
                            @if (NotificationState.UnreadCount > 0)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light">
                                    @NotificationState.UnreadCount
                                    <span class="visually-hidden">notificaciones</span>
                                </span>
                            }
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="notifMenu" style="width: 300px; max-height: 400px; overflow-y: auto;">
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <span>Notificaciones</span>
                                @if (NotificationState.UnreadCount > 0)
                                {
                                    <button class="btn btn-link btn-sm text-decoration-none" @onclick="MarkAllRead">Marcar leídas</button>
                                }
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            @if (NotificationState.Notifications.Any())
                            {
                                @foreach (var notif in NotificationState.Notifications)
                                {
                                     <li>
                                        <a class="dropdown-item text-wrap @(notif.IsRead ? "text-muted" : "fw-bold")" href="#" @onclick="() => ReadNotification(notif.Id)">
                                            <small class="d-block text-primary mb-1">@notif.Title</small>
                                            <span>@notif.Message</span>
                                            <div class="text-end mt-1"><small class="opacity-50" style="font-size: 0.7rem;">@notif.CreatedAt.ToString("g")</small></div>
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                }
                            }
                            else
                            {
                                <li class="dropdown-item text-center text-muted small py-3">No tenés notificaciones</li>
                            }
                        </ul>
                    </div>
                </Authorized>
            </AuthorizeView>

            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                    Mi cuenta
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                    @foreach (var action in AccountLinks)
                    {
                        <li><a class="dropdown-item" href="@action.Href">@action.Text</a></li>
                    }
                </ul>
            </div>
            
            @* Optional: Keep Cart if needed, or hide if strictly single-booking *@
            
            <a href="/cart" class="btn btn-primary position-relative ms-2">
                <i class="fa-solid fa-cart-shopping"></i>
                @if (CartState.Count > 0)
                {
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        @CartState.Count
                        <span class="visually-hidden">items en carrito</span>
                    </span>
                }
            </a>
        </div>
        <nav class="nav-menu mt-3">
            <div class="nav nav-pills justify-content-center justify-content-lg-between flex-wrap gap-2">
                @foreach (var link in NavLinks)
                {
                    <a class="nav-link" href="@link.Href">@link.Text</a>
                }
            </div>
        </nav>
    </div>
</header>

@code {
    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    [Inject]
    private CartStore CartState { get; set; } = default!;

    [Inject]
    private NotificationService NotificationState { get; set; } = default!;

    [Parameter]
    public string HeaderId { get; set; } = string.Empty;

    [Parameter]
    public string Brand { get; set; } = string.Empty;

    [Parameter]
    public string BrandHref { get; set; } = "#";

    [Parameter, EditorRequired]
    public SearchConfig Search { get; set; } = default!;

    [Parameter, EditorRequired]
    public IReadOnlyList<MenuActionModel> AccountLinks { get; set; } = Array.Empty<MenuActionModel>();

    [Parameter, EditorRequired]
    public IReadOnlyList<NavLinkModel> NavLinks { get; set; } = Array.Empty<NavLinkModel>();

    private string searchTerm = string.Empty;

    protected override void OnInitialized()
    {
        CartState.OnChange += StateHasChanged;
        NotificationState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        CartState.OnChange -= StateHasChanged;
        NotificationState.OnChange -= StateHasChanged;
    }

    private void ReadNotification(Guid id)
    {
        NotificationState.MarkAsRead(id);
    }
    
    private void MarkAllRead()
    {
        NotificationState.MarkAllAsRead();
    }

    private void OnSearch()
    {
        var term = searchTerm?.Trim();
        var destination = string.IsNullOrWhiteSpace(term)
            ? "/search"
            : $"/search?query={Uri.EscapeDataString(term)}";

        Navigation.NavigateTo(destination);
    }
}
