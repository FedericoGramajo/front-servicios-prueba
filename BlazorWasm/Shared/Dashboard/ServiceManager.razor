@using ClientLibrary.Models.ServicioAhora.ServOffering
@using ClientLibrary.Models.Landing
@using ClientLibrary.Models.ProfessionalCat
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IProfessionalDashboardService DashboardService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<div class="surface-card">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-3">
        <div>
            <h4 class="mb-1">Servicios por rubro</h4>
            <p class="text-muted mb-0">Mostrando tus publicaciones por categoría</p>
        </div>
    </div>
    @if (MyCategories == null)
    {
        <p>Cargando información...</p>
    }
    else if (!MyCategories.Any())
    {
         <div class="alert alert-info">
            No tienes categorías asignadas. Agrega una categoría arriba para comenzar a publicar servicios.
         </div>
    }
    else
    {
        @foreach (var category in MyCategories)
        {
            var servicesInCategory = MyServices?.Where(s => s.CategoryId == category.CategoryId).ToList() ?? new List<GetServiceOffering>();

            <div class="service-group mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                    <div>
                        <h5 class="mb-0">@category.CategoryName</h5>
                        <small class="text-secondary">@servicesInCategory.Count servicio(s)</small>
                    </div>
                    <button class="btn btn-primary btn-sm" @onclick="() => OpenAddServiceModal(category.CategoryName, category.CategoryId)">
                        <i class="fa-solid fa-plus me-1"></i> Agregar servicio
                    </button>
                </div>
                
                @if (servicesInCategory.Any())
                {
                    <div class="row g-3">
                        @foreach (var service in servicesInCategory)
                        {
                            <div class="col-md-4">
                                <ProfessionalServiceCard 
                                    Service="@service" 
                                    Category="@category.CategoryName"
                                    OnEdit="@((s) => EditService(s, category.CategoryName))"
                                    OnDelete="DeleteService" />
                            </div>
                        }
                    </div>
                }
                else 
                {
                    <div class="p-4 text-center border rounded bg-light text-muted">
                        <p class="mb-0">No hay servicios en esta categoría.</p>                        
                    </div>
                }
            </div>
        }
    }
</div>

@if (showAddServiceModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditingService ? "Editar servicio" : "Publicar nuevo servicio")</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddServiceModal"></button>
                </div>
                <EditForm Model="@newService" OnValidSubmit="SaveService">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre del servicio</label>
                            <InputText class="form-control" @bind-Value="newService.Name" placeholder="Ej. Limpieza de tapizados" />
                            <ValidationMessage For="@(() => newService.Name)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoría</label>
                            <input type="text" class="form-control" value="@newService.CategoryName" disabled readonly />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Precio estimado</label>
                            <InputNumber class="form-control" @bind-Value="newService.BasePrice" />
                            <ValidationMessage For="@(() => newService.BasePrice)" />
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Duración Estimada</label>
                                <select class="form-select" value="@newService.EstimatedDuration" @onchange="e => newService.EstimatedDuration = int.TryParse(e.Value?.ToString(), out var v) ? v : 60">
                                    <option value="60">1 hora</option>
                                    <option value="120">2 horas</option>
                                    <option value="180">3 horas</option>
                                    <option value="240">4 horas</option>
                                    <option value="300">5 horas</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="form-check form-switch mb-2">
                                    <InputCheckbox class="form-check-input" role="switch" id="serviceStatus" @bind-Value="newService.Status" />
                                    <label class="form-check-label" for="serviceStatus">@(newService.Status ? "Activo" : "Inactivo")</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Imagen del servicio</label>
                            <InputFile OnChange="HandleImageUpload" class="form-control" accept="image/*" />
                            @if (!string.IsNullOrEmpty(newService.Image))
                            {
                                <div class="mt-2 text-center">
                                    <img src="@newService.Image" alt="Vista previa" class="img-thumbnail" style="max-height: 200px;" />
                                </div>
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <InputTextArea class="form-control" rows="3" @bind-Value="newService.Description" />
                            <ValidationMessage For="@(() => newService.Description)" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseAddServiceModal" disabled="@IsLoading">Cancelar</button>
                        <button type="submit" class="btn btn-primary" disabled="@IsLoading">
                            @(IsLoading ? "Procesando..." : (isEditingService ? "Guardar Cambios" : "Publicar"))
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public List<GetServiceOffering> MyServices { get; set; } = new();
    [Parameter] public List<GetProfessionalCategory> MyCategories { get; set; } = new();
    [Parameter] public EventCallback OnServiceChanged { get; set; }

    private bool showAddServiceModal = false;
    private GetServiceOffering newService = new();
    private bool isEditingService = false;
    private bool IsLoading = false;
    private Guid selectedCategoryId;

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            try
            {
                var resizedFile = await file.RequestImageFileAsync(file.ContentType, 600, 400);
                var buffer = new byte[resizedFile.Size];
                await resizedFile.OpenReadStream().ReadAsync(buffer);
                var base64 = Convert.ToBase64String(buffer);
                newService.Image = $"data:{file.ContentType};base64,{base64}";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading image: {ex.Message}");
                await JS.ToastrError("Error al procesar la imagen.");
            }
        }
    }

    public void OpenAddServiceModal(string? categoryName = null, Guid? categoryId = null, GetServiceOffering? serviceToEdit = null)
    {
        if (serviceToEdit != null)
        {
            isEditingService = true;
            newService = new GetServiceOffering
            {
                Id = serviceToEdit.Id,
                Name = serviceToEdit.Name,
                CategoryName = categoryName ?? serviceToEdit.CategoryName,
                BasePrice = serviceToEdit.BasePrice,
                Description = serviceToEdit.Description ?? "",
                Image = serviceToEdit.Image,
                Status = serviceToEdit.Status,
                EstimatedDuration = serviceToEdit.EstimatedDuration
            };
            selectedCategoryId = serviceToEdit.CategoryId;
        }
        else
        {
            isEditingService = false;
            newService = new(); 
            if (!string.IsNullOrEmpty(categoryName))
            {
                newService.CategoryName = categoryName;
            }
            selectedCategoryId = categoryId ?? Guid.Empty;
        }
        showAddServiceModal = true;
    }

    private void CloseAddServiceModal()
    {
        showAddServiceModal = false;
    }

    private async Task SaveService()
    {
        IsLoading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            // Try to find sub claim or nameidentifier
            var professionalId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value 
                                    ?? user.FindFirst("sub")?.Value;

            if (string.IsNullOrEmpty(professionalId))
            {
                    await JS.ToastrError("No se pudo identificar al profesional.");
                    return;
            }

            if (isEditingService)
            {
                var createModel = new UpdateServiceOffering
                {
                    Id = newService.Id,
                    Name = newService.Name,
                    Description = newService.Description,
                    BasePrice = newService.BasePrice,
                    Image = newService.Image,
                    CategoryId = selectedCategoryId,
                    Status = newService.Status,
                    EstimatedDuration = newService.EstimatedDuration
                };
                await DashboardService.UpdateServiceAsync(createModel);
                await JS.ToastrSuccess("Servicio actualizado correctamente.");
            }
            else
            {
                var createModel = new CreateServiceOffering
                {
                    Name = newService.Name,
                    Description = newService.Description,
                    BasePrice = newService.BasePrice,
                    Image = newService.Image,
                    CategoryId = selectedCategoryId,
                    ProfessionalId = professionalId,
                    Status = newService.Status,
                    EstimatedDuration = newService.EstimatedDuration
                };

                await DashboardService.AddServiceAsync(createModel);
                await JS.ToastrSuccess("Servicio publicado correctamente.");
            }
            
            showAddServiceModal = false;
            await OnServiceChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            await JS.ToastrError("Error al guardar el servicio.");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void EditService(GetServiceOffering service, string categoryName)
    {
        OpenAddServiceModal(categoryName, service.CategoryId, service);
    }

    private async Task DeleteService(GetServiceOffering service)
    {
         await DashboardService.DeleteServiceAsync(service.Id.ToString());
         await JS.ToastrSuccess("Servicio eliminado.");
         await OnServiceChanged.InvokeAsync();
    }
}
