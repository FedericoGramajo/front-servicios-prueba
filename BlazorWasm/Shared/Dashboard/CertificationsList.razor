@using ClientLibrary.Models
@using ClientLibrary.Models.Landing
@using ClientLibrary.Models.ProfessionalLicense
@using ClientLibrary.Models.ProfessionalCat
@using ClientLibrary.Services.Contracts
@using System.Globalization
@inject IProfessionalDashboardService DashboardService
@inject IJSRuntime JS

<div class="surface-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="mb-1">Tus certificaciones</h5>
            <p class="text-muted small mb-0">Subí tus licencias y cursos para aumentar la confianza de los clientes.</p>
        </div>
        <button class="btn btn-outline-primary btn-sm" @onclick="ShowAddModal">
            <i class="fa-solid fa-plus me-2"></i> Agregar licencia
        </button>
    </div>
    <div class="list-group list-group-flush">
        @foreach (var lic in Licenses)
        {
            <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="license-icon-wrapper">
                        @if (!string.IsNullOrEmpty(lic.Image))
                        {
                            <img src="@lic.Image" alt="Licencia" class="rounded shadow-sm" style="width: 48px; height: 48px; object-fit: cover;" />
                        }
                        else
                        {
                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                <i class="fa-solid fa-file-contract text-secondary fs-4"></i>
                            </div>
                        }
                    </div>
                    <div>
                        <h6 class="mb-0">@lic.Number - @lic.Issuer</h6>
                        <div class="d-flex flex-wrap gap-2 mt-1">
                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle">@lic.CategoryName</span>
                            <small class="text-muted"><i class="fa-solid fa-calendar-day me-1"></i> Emitido: @lic.IssueDate.ToString("dd/MM/yyyy")</small>
                            @if (lic.ExpirationDate.HasValue)
                            {
                                <small class="text-muted"><i class="fa-solid fa-calendar-xmark me-1"></i> Vence: @lic.ExpirationDate.Value.ToString("dd/MM/yyyy")</small>
                            }
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" @onclick="() => ShowEditModal(lic)">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" @onclick="() => PrepareDelete(lic.Id)">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        }
    </div>
</div>


<LicenseFormModal @ref="FormModal" Categories="Categories" OnSave="HandleSave" />
<BlazorWasm.Shared.Components.ConfirmationModal @ref="DeleteModal" 
    Title="Eliminar Licencia" 
    Message="¿Estás seguro de que querés eliminar esta licencia? Esta acción no se puede deshacer."
    OnConfirm="ConfirmDelete" />

@code {
    [Parameter] public string ProfessionalId { get; set; } = string.Empty;
    [Parameter] public List<GetProfessionalCategory> Categories { get; set; } = new();

    private List<GetProfessionalLicense> Licenses { get; set; } = new();
    private LicenseFormModal FormModal = default!;
    private BlazorWasm.Shared.Components.ConfirmationModal DeleteModal = default!;
    private Guid SelectedId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadLicenses();
    }

    private async Task LoadLicenses()
    {
        if (!string.IsNullOrEmpty(ProfessionalId))
        {
            Licenses = await DashboardService.GetLicensesAsync(ProfessionalId);
        }
    }

    private void ShowAddModal()
    {
        FormModal.Show(null, ProfessionalId);
    }

    private void ShowEditModal(GetProfessionalLicense lic)
    {
        FormModal.Show(lic);
    }

    private async Task HandleSave(bool isEdit)
    {
        var modelVM = FormModal.GetModel();
        ServiceResponse response;

        if (isEdit)
        {
            var updateModel = new UpdateProfessionalLicense
            {
                Id = modelVM.Id,
                Number = modelVM.Number,
                Issuer = modelVM.Issuer,
                IssueDate = modelVM.IssueDate,
                ExpirationDate = modelVM.ExpirationDate,
                CategoryId = modelVM.CategoryId,
                Image = modelVM.Image
            };
            response = await DashboardService.UpdateLicenseAsync(updateModel);
        }
        else
        {
            var createModel = new CreateProfessionalLicense
            {
                Number = modelVM.Number,
                Issuer = modelVM.Issuer,
                IssueDate = modelVM.IssueDate,
                ExpirationDate = modelVM.ExpirationDate,
                CategoryId = modelVM.CategoryId,
                ProfessionalId = modelVM.ProfessionalId,
                Image = modelVM.Image
            };
            response = await DashboardService.AddLicenseAsync(createModel);
        }

        if (response.success)
        {
            await JS.ToastrSuccess("Licencia guardada correctamente");
            await FormModal.Hide();
            await LoadLicenses();
        }
        else
        {
            await JS.ToastrError(response.Message);
        }
    }

    private async Task PrepareDelete(Guid id)
    {
        SelectedId = id;
        await DeleteModal.Show();
    }

    private async Task ConfirmDelete()
    {
        var response = await DashboardService.RemoveLicenseAsync(SelectedId);
        if (response.success)
        {
            await JS.ToastrSuccess("Licencia eliminada");
            await DeleteModal.Hide();
            await LoadLicenses();
        }
        else
        {
            await JS.ToastrError(response.Message);
        }
    }
}
