@inject IProfessionalDashboardService DashboardService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<div class="row g-4">
    <div class="col-lg-4">
        <div class="p-3 border rounded bg-light">
            <h6 class="mb-3">Configurar horarios</h6>
            <div class="mb-3">
                <label class="form-label small">Días de atención</label>
                
                <CalendarSelector @bind-SelectedDates="SelectedDates" />
                
                <small class="text-muted">Seleccioná días individuales o mantené Shift presionado para seleccionar un rango.</small>
            </div>
            <div class="mb-3">
                    <label class="form-label small">Horario</label>
                    <div class="d-flex gap-2 align-items-center">
                        <input type="time" class="form-control" @bind="NewStartTime" />
                        <span>a</span>
                        <input type="time" class="form-control" @bind="NewEndTime" />
                    </div>
            </div>
            <button class="btn btn-primary w-100" @onclick="AddAvailability" disabled="@IsLoading">
                <i class="fa-solid fa-plus me-2"></i> @(IsLoading ? "Agregando..." : "Agregar horario")
            </button>
        </div>
    </div>
    <div class="col-lg-8">
        @if (Availabilities == null || !Availabilities.Any())
        {
            <div class="alert alert-light border border-dashed text-center py-4">
                <i class="fa-regular fa-clock fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">No has configurado tu disponibilidad.</p>
            </div>
        }
        else
        {
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-hover align-middle">
                    <thead style="position: sticky; top: 0; background-color: white; z-index: 1;">
                        <tr>
                            <th>Día</th>
                            <th>Horario</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Availabilities)
                        {
                            <tr>
                                <td>
                                    <span class="fw-semibold">@item.Date.ToString("dd MMM yyyy", LocalCulture)</span>
                                    <small class="text-muted d-block">@LocalCulture.DateTimeFormat.GetDayName(item.DayOfWeek)</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="fa-regular fa-clock text-muted"></i>
                                        <span>@item.StartTime.ToString(@"hh\:mm") - @item.EndTime.ToString(@"hh\:mm")</span>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveAvailability(item.Id)" disabled="@IsLoading">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public List<ProfessionalAvailability> Availabilities { get; set; } = new();
    [Parameter] public EventCallback OnAvailabilityChanged { get; set; }

    private List<DateTime> SelectedDates { get; set; } = new();
    private DateTime NewStartTime { get; set; } = DateTime.Today.AddHours(9); 
    private DateTime NewEndTime { get; set; } = DateTime.Today.AddHours(17);
    
    private bool IsLoading { get; set; } = false; 
    private string? ProfessionalId { get; set; }

    private readonly CultureInfo LocalCulture = new("es-AR");

    private Dictionary<int, string> DayNames = new() 
    {
        {1, "Lunes"}, {2, "Martes"}, {3, "Miércoles"}, {4, "Jueves"}, {5, "Viernes"}, {6, "Sábado"}, {0, "Domingo"}
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        ProfessionalId = authState.User.FindFirst("nameid")?.Value 
                      ?? authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value 
                      ?? string.Empty;
    }

    private async Task AddAvailability()
    {
        if (!SelectedDates.Any())
        {
            await JS.ToastrWarning("Seleccioná al menos una fecha.");
            return;
        }

        if (NewEndTime <= NewStartTime)
        {
            await JS.ToastrWarning("La hora de fin debe ser mayor a la de inicio.");
            return;
        }

        IsLoading = true;
        int successCount = 0;
        string? lastError = null;
        try
        {
            foreach (var date in SelectedDates)
            {
                var request = new AddAvailabilityRequest
                { 
                    ProfessionalId = ProfessionalId ?? string.Empty,
                    Date = date, 
                    StartTime = NewStartTime.ToString("HH:mm"), 
                    EndTime = NewEndTime.ToString("HH:mm") 
                };

                Console.WriteLine($"[Availability] Sending: ProfessionalId={request.ProfessionalId}, Date={request.Date}, Start={request.StartTime}, End={request.EndTime}");
                
                try
                {
                    var result = await DashboardService.AddAvailabilityAsync(request);
                    if (result != null && result.success)
                    {
                        successCount++;
                    }
                    else
                    {
                        lastError = result?.Message ?? "Respuesta vacía del servidor";
                        Console.WriteLine($"[Availability] Error for date {request.Date}: {lastError}");
                    }
                }
                catch (Exception innerEx)
                {
                    lastError = innerEx.Message;
                    Console.WriteLine($"[Availability] Exception for date {request.Date}: {innerEx}");
                }
            }

            if (successCount > 0)
            {
                await OnAvailabilityChanged.InvokeAsync(); 
                await JS.ToastrSuccess($"Se agregaron {successCount} horario(s) correctamente.");
                SelectedDates.Clear();
            }
            else
            {
                await JS.ToastrError(lastError ?? "No se pudo agregar ningún horario.");
            }
        }
        catch (Exception ex)
        {
             Console.WriteLine($"[Availability] Fatal error: {ex}");
             await JS.ToastrError($"Error al guardar: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task RemoveAvailability(Guid id)
    {
        IsLoading = true;
        try
        {
            var response = await DashboardService.RemoveAvailabilityAsync(id);
            if (response.success)
            {
                await OnAvailabilityChanged.InvokeAsync();
                await JS.ToastrSuccess(response.Message);
            }
            else
            {
                    await JS.ToastrError(response.Message);
            }
        }
        catch (Exception ex)
        {
             Console.WriteLine(ex);
             await JS.ToastrError("Error al eliminar disponibilidad.");
        }
        finally
        {
            IsLoading = false;
        }
    }
}
