@using System.Globalization

<div class="surface-card">
    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 align-items-lg-center mb-3">
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <span class="fw-semibold">Filtros r√°pidos:</span>
            <button class="btn btn-sm @(FilterStatus == "todas" ? "btn-secondary" : "btn-outline-secondary")" @onclick='() => SetFilter("todas")'>
                Todos
            </button>
            <button class="btn btn-sm @(FilterStatus == "pendiente" ? "btn-warning text-white" : "btn-outline-secondary")" @onclick='() => SetFilter("pendiente")'>
                Pendientes
            </button>
            <button class="btn btn-sm @(FilterStatus == "en-curso" ? "btn-info text-white" : "btn-outline-secondary")" @onclick='() => SetFilter("en-curso")'>
                En curso
            </button>
            <button class="btn btn-sm @(FilterStatus == "completado" ? "btn-primary" : "btn-outline-secondary")" @onclick='() => SetFilter("completado")'>
                Completados
            </button>
        </div>

        <div class="search-bar small" role="search">
            <div class="input-group">
                <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
                <input class="form-control" type="search" placeholder="Buscar por servicio o profesional" @bind="Term" @bind:event="oninput" />
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table align-middle table-borderless mb-0">
            <thead class="text-muted small">
                <tr>
                    <th>Servicio</th>
                    <th>Profesional</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th class="text-end">Total</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in FilteredHistory)
                {
                    <tr>
                        <td>
                            <div class="fw-semibold">@item.Service</div>
                            <small class="text-secondary">@item.Category</small>
                        </td>
                        <td>@item.Professional</td>
                        <td>@item.Date.ToString("dd MMM", LocalCulture)</td>
@using ClientLibrary.Helper
                        <td>
                            <span class="badge @item.State.BadgeClass">
                                <i class="@item.State.IconClass me-1 small"></i>
                                @item.State.DisplayName
                            </span>
                        </td>
                        <td class="text-end fw-semibold">@item.Total.ToString("C0", LocalCulture)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private readonly CultureInfo LocalCulture = new("es-AR");

    [Parameter] public List<ServiceHistoryItem> History { get; set; } = new();

    private string Term { get; set; } = string.Empty;
    private string FilterStatus { get; set; } = "todas";

    private IEnumerable<ServiceHistoryItem> FilteredHistory => History
        .Where(h => FilterStatus == "todas" || IsStatusMatch(h.Status, FilterStatus))
        .Where(h => string.IsNullOrWhiteSpace(Term)
            || h.Service.Contains(Term, StringComparison.OrdinalIgnoreCase)
            || (h.Professional != null && h.Professional.Contains(Term, StringComparison.OrdinalIgnoreCase)));

    private bool IsStatusMatch(string current, string filter)
    {
        if (string.IsNullOrEmpty(current)) return false;
        var c = current.ToLower();
        return filter switch
        {
            "pendiente" => c == "pending" || c == "pendiente",
            "en-curso" => c == "inprogress" || c == "en curso",
            "completado" or "finalizado" => c == "completed" || c == "completado" || c == "finalizado",
            _ => c == filter
        };
    }

    private void SetFilter(string status)
    {
        FilterStatus = status;
    }
}
