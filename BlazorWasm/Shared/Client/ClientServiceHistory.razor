@using System.Globalization

<div class="surface-card">
    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 align-items-lg-center mb-3">
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <span class="fw-semibold">Filtros r√°pidos:</span>
            <button class="btn btn-sm @(FilterStatus == "todas" ? "btn-secondary" : "btn-outline-secondary")" @onclick='() => SetFilter("todas")'>
                Todos
            </button>
            <button class="btn btn-sm @(FilterStatus == "pendiente" ? "btn-warning text-white" : "btn-outline-secondary")" @onclick='() => SetFilter("pendiente")'>
                Pendientes
            </button>
            <button class="btn btn-sm @(FilterStatus == "en-progreso" ? "btn-info text-white" : "btn-outline-secondary")" @onclick='() => SetFilter("en-progreso")'>
                En progreso
            </button>
            <button class="btn btn-sm @(FilterStatus == "completado" ? "btn-success" : "btn-outline-secondary")" @onclick='() => SetFilter("completado")'>
                Completados
            </button>
        </div>

        <div class="search-bar small" role="search">
            <div class="input-group">
                <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
                <input class="form-control" type="search" placeholder="Buscar por servicio o profesional" @bind="Term" @bind:event="oninput" />
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table align-middle table-borderless mb-0">
            <thead class="text-muted small">
                <tr>
                    <th>Servicio</th>
                    <th>Profesional</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th class="text-end">Total</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in FilteredHistory)
                {
                    <tr>
                        <td>
                            <div class="fw-semibold">@item.Service</div>
                            <small class="text-secondary">@item.Category</small>
                        </td>
                        <td>@item.Professional</td>
                        <td>@item.Date.ToString("dd MMM", LocalCulture)</td>
                        <td>
                            <span class="status-pill @item.Status">@StatusLabel(item.Status)</span>
                        </td>
                        <td class="text-end fw-semibold">@item.Total.ToString("C0", LocalCulture)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private readonly CultureInfo LocalCulture = new("es-AR");

    [Parameter] public List<ServiceHistoryItem> History { get; set; } = new();

    private string Term { get; set; } = string.Empty;
    private string FilterStatus { get; set; } = "todas";

    private IEnumerable<ServiceHistoryItem> FilteredHistory => History
        .Where(h => FilterStatus == "todas" || h.Status == FilterStatus)
        .Where(h => string.IsNullOrWhiteSpace(Term)
            || h.Service.Contains(Term, StringComparison.OrdinalIgnoreCase)
            || h.Professional.Contains(Term, StringComparison.OrdinalIgnoreCase));

    private void SetFilter(string status)
    {
        FilterStatus = status;
    }

    private static string StatusLabel(string status) => status switch
    {
        "pendiente" => "Pendiente",
        "en-progreso" => "En progreso",
        "completado" => "Completado",
        _ => status
    };
}
