@using System.Globalization
@using ClientLibrary.Models.Booking
@using ClientLibrary.Services.Contracts

<div class="time-slot-picker">
    @if (IsLoadingDays)
    {
        <div class="text-center py-3">
            <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
            <span class="ms-2">Consultando disponibilidad...</span>
        </div>
    }
    else if (!AvailableDays.Any())
    {
        <div class="alert alert-warning text-center">
            <i class="fa-solid fa-calendar-xmark me-2"></i>No hay días con disponibilidad en los próximos 14 días.
        </div>
    }
    else
    {
        <div class="mb-3">
            <label class="form-label fw-bold">Seleccioná una fecha</label>
            <div class="d-flex gap-2 overflow-auto pb-2" style="scrollbar-width: thin;">
                @foreach (var date in AvailableDays)
                {
                    var isSelected = date.Date == SelectedDate?.Date;

                    <button class="btn @(isSelected ? "btn-primary" : "btn-outline-secondary") flex-shrink-0 text-center" 
                            style="min-width: 80px;"
                            @onclick="() => SelectDate(date)">
                        <div class="small text-uppercase">@date.ToString("ddd", LocalCulture)</div>
                        <div class="fw-bold fs-5">@date.Day</div>
                    </button>
                }
            </div>
        </div>

        @if (SelectedDate.HasValue && AvailableSlots.Any())
        {
            <div class="mb-3">
                <label class="form-label fw-bold">Horarios disponibles</label>
                <div class="d-grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));">
                    @foreach (var slot in AvailableSlots)
                    {
                        <button class="btn @(slot == SelectedSlot ? "btn-success" : "btn-outline-primary") btn-sm"
                                @onclick="() => SelectSlot(slot)">
                            @slot.ToString("HH:mm")
                        </button>
                    }
                </div>
            </div>
        }
        else if (SelectedDate.HasValue)
        {
            <div class="alert alert-light border text-center">
                <small class="text-muted">Seleccioná un día para ver los horarios.</small>
            </div>
        }
    }
</div>

@code {
    [Inject] private IAvailabilityService AvailabilityService { get; set; } = default!;

    [Parameter] public string ProfessionalId { get; set; } = string.Empty;
    [Parameter] public Guid ServiceId { get; set; }
    [Parameter] public int DurationMinutes { get; set; } = 60;
    [Parameter] public EventCallback<DateTime> OnSlotSelected { get; set; }

    private static readonly CultureInfo LocalCulture = new("es-AR");
    
    private DateTime? SelectedDate { get; set; }
    private DateTime? SelectedSlot { get; set; }
    
    // Cache de slots por día
    private Dictionary<DateTime, List<DateTime>> SlotsByDay { get; set; } = new();
    private List<DateTime> AvailableDays { get; set; } = new();
    private List<DateTime> AvailableSlots { get; set; } = new();
    private bool IsLoadingDays { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        await PreloadAvailability();
    }

    private async Task PreloadAvailability()
    {
        if (ServiceId == Guid.Empty) return;

        IsLoadingDays = true;

        // Consultar los 14 días en paralelo
        var tasks = new List<Task<(DateTime Date, List<DateTime> Slots)>>();
        for (int i = 0; i < 14; i++)
        {
            var date = DateTime.Today.AddDays(i);
            tasks.Add(LoadDaySlots(date));
        }

        var results = await Task.WhenAll(tasks);

        SlotsByDay.Clear();
        foreach (var (date, slots) in results)
        {
            if (slots.Any())
            {
                SlotsByDay[date.Date] = slots;
            }
        }

        AvailableDays = SlotsByDay.Keys.OrderBy(d => d).ToList();

        // Auto-seleccionar el primer día disponible
        if (AvailableDays.Any())
        {
            SelectedDate = AvailableDays.First();
            AvailableSlots = SlotsByDay[SelectedDate.Value.Date];
        }

        IsLoadingDays = false;
    }

    private async Task<(DateTime Date, List<DateTime> Slots)> LoadDaySlots(DateTime date)
    {
        try
        {
            var allSlots = await AvailabilityService.GetAvailableSlotsAsync(ProfessionalId, date, ServiceId);
            var filtered = allSlots.Where(s => s.Minute == 0).OrderBy(s => s).ToList();
            return (date, filtered);
        }
        catch
        {
            return (date, new List<DateTime>());
        }
    }

    private void SelectDate(DateTime date)
    {
        SelectedDate = date;
        SelectedSlot = null;
        AvailableSlots = SlotsByDay.ContainsKey(date.Date) ? SlotsByDay[date.Date] : new();
    }

    private async Task SelectSlot(DateTime slot)
    {
        SelectedSlot = slot;
        await OnSlotSelected.InvokeAsync(slot);
    }
}

